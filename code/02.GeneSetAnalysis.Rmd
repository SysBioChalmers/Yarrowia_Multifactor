---
title: "Gene Set Analysis"
author: "Simone Zaghen"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
output: 
  html_document: 
    toc: true
    number_section: true
    toc_float: 
      collapsed: false
      smooth_scroll: true
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../results/Reports") })

---

This script takes as input a list of comparisons (that needs to contain at least gene name, log fold change, and p value) and performs the gene set analysis using the package piano. 

# Load packages and functions
```{r, message=FALSE}
library(piano)
library(ggplot2)
library(ggpubr)

source('Functions/consGSA.R')
source('Functions/consGSAplot.R')
source('Functions/consGSAtable.R')

```

# Import data

```{r, warning=FALSE}
load("../results/Comparison_Output/Comparison_Output.RData")

```

# Gene set analysis

## Create gene set collection
Create gene set collection and subset the analysis only for different levels of the gene set collection. 

```{r}
amigo <- read.csv2("../data/Gene_Set.csv") #load the GO Term table 

#Run the GSA based on different levels (biological process/molecular function/cellular component)
#First indicate which rows to keep
    keep_bio_pro <- amigo$Level == 'biological_process'
    keep_mol_fun <- amigo$Level == 'molecular_function'
    keep_cell_com <- amigo$Level == "cellular_component"

#Then subset to only keep those rows
    geneSetBP <- amigo[keep_bio_pro, ]
    geneSetMF <- amigo[keep_mol_fun,]
    geneSetCC <- amigo[keep_cell_com,]

#Remove all other rows except genes and the Go-Terms  
    geneSetBP<- subset(geneSetBP, select = c("genes","Term"))
    geneSetMF<- subset(geneSetMF, select = c("genes","Term"))
    geneSetCC<- subset(geneSetCC, select = c("genes","Term"))

#load the gene set collection for each level
    myGsc_BP <- loadGSC(geneSetBP, type = "data.frame")
    myGsc_MF <- loadGSC(geneSetMF, type = "data.frame")
    myGsc_CC <- loadGSC(geneSetCC, type = "data.frame")

```

## Perform GSA
Loop the consensus gene set analysis through all the comparisons we have. For each comparison three consensus gene set analysis will be performed (one for each level (biological process, molecular function, cellular component)). For each comparison a graph containing the GSA results for biological process, molecular function, and cellular component will be created. 

```{r, message=FALSE, warning=FALSE, results='hide'}
#create directories where to save output of GSA
if (!dir.exists("../results/Gene_Set_Analysis")){dir.create("../results/Gene_Set_Analysis")}
if (!dir.exists("../results/Gene_Set_Analysis/Plots")){dir.create("../results/Gene_Set_Analysis/Plots")}

res_list <- list() # Create empty list in which to store results of the consensus gene set analysis

for (i in 1:length(comp_list)) {
    TopTable <- as.data.frame(comp_list[i], col.names = "", row.names = 1) #create TopTable that is input for analysis
    res_Bars_BP<-consGSA(TopTable,myGsc_BP) #run consensus gene set analysis for biological process
    res_Bars_MF<-consGSA(TopTable,myGsc_MF) #run consensus gene set analysis for molecular function
    res_Bars_CC<-consGSA(TopTable,myGsc_CC) #run consensus gene set analysis for cellular component

    #Create the consensusGSA plots: A for Biological process, B for molecular function, C for cellular component
    A <- consGSAplot(resList=res_Bars_BP, rankScore=25, Pcutoff=0.01, distinct='distinct', 
                     savePlot=FALSE, title='Biological Process - rankScore 25, p<0.01')
    B <- consGSAplot(resList=res_Bars_MF, rankScore=25, Pcutoff=0.01, distinct='distinct', 
                     savePlot=FALSE, title='Molecular Function - rankScore 25, p<0.01')
    C <- consGSAplot(resList=res_Bars_CC, rankScore=25, Pcutoff=0.01, distinct='distinct', 
                     savePlot=FALSE, title='Cellular Component - rankScore 25, p<0.01')
    
    #Arrange the plots from the consGSA, annotate them, and export them
    Figure <- ggarrange(A,B,C, ncol=1, nrow=3, common.legend = TRUE, legend = "bottom") 
    tmp_plot <- annotate_figure(Figure, top = text_grob((names(comp_list[i])), color = "red", face = "bold", size = 18))
    ggsave(tmp_plot, path = "../results/Gene_Set_Analysis/Plots" , 
           file=paste0("plot_", names(comp_list[i]), ".pdf"), width = 10, height = 16)
    
    #Save results in result_Table
    result_Table_BP <- consGSAtable(resList=res_Bars_BP, rankScore=25, Pcutoff=0.01, distinct='distinct')
    result_Table_MF <- consGSAtable(resList=res_Bars_MF, rankScore=25, Pcutoff=0.01, distinct='distinct')
    result_Table_CC <- consGSAtable(resList=res_Bars_CC, rankScore=25, Pcutoff=0.01, distinct='distinct')
   
    consGSAtable_by_level <- list(BP=result_Table_BP, CC=result_Table_CC, MF=result_Table_MF) #list of results for each comparison  
    res_list[[i]]<- consGSAtable_by_level #move the list into a list, where all the samples will be grouped
    names(res_list)[i] <- names(comp_list[i]) #assign names to each element of the list
}

```

Export the results both in RData file and csv files

```{r, warning = FALSE}
if (!dir.exists("../results/Gene_Set_Analysis/OutputGSA")){dir.create("../results/Gene_Set_Analysis/OutputGSA")}
setwd("../results/Gene_Set_Analysis/OutputGSA")

save(res_list, file = "GSA_Result.RData")

for (i in 1:length(res_list)){
  for (j in 1:length(res_list[[i]])){
  filename = paste0(names(res_list[[i]])[[j]], "_", names(res_list)[i], ".csv")
  tmp_data = (res_list[[i]][[j]])
  write.csv2(tmp_data, filename)
}}

```


